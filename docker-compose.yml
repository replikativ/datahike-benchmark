version: "3.7"
services:
  postgres:
    image: postgres:12.4
    ports:
      - "5440:5432"
    volumes:
      - ./docker-postgres:/docker-entrypoint-initdb.d
    environment:
      - POSTGRES_DATABASES="performance-sr-t0", "performance-sr-t1", "performance-sw-t0", "performance-sw-t1"
      - POSTGRES_USER=datahike
      - POSTGRES_PASSWORD=clojure
  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    volumes:
      - ./docker-mysql:/docker-entrypoint-initdb.d
    environment:
      - MYSQL_DATABASES="performance-sr-t0", "performance-sr-t1", "performance-sw-t0", "performance-sw-t1"
      - MYSQL_USER=datahike
      - MYSQL_RANDOM_ROOT_PASSWORD=clojure

  datomic:
    image: akiel/datomic-free:0.9.5703-3
    ports:
      - "4334-4336:4334-4336"
    environment:
      - ADMIN_PASSWORD=clojure
      - DATOMIC_PASSWORD=clojure

  benchmarks:
    build: .
    ports:
      - "5000:5000"
    network_mode: "host"
    depends_on:
      - postgres
      - mysql
      - datomic
    volumes:
      - db:/tmp/output-db
      - plots:/tmp/plots
      - errors:/tmp/datahike-benchmark-errors
      - signals:/tmp/signals

  results:
    build: ./result-presentation
    ports:
      - "4000:4000"
    depends_on:
      - benchmarks
    volumes:
      - db:/tmp/output-db
      - presentation:/tmp/presentation
      - signals:/tmp/signals

volumes:
  db:
    external:
      name: dh-benchmark-db
  plots:
    external:
      name: dh-benchmark-plots
  errors:
    external:
      name: dh-benchmark-errors
  presentation:
    external:
      name: dh-benchmark-presentation
  signals:
    external:
      name: dh-benchmark-signals
